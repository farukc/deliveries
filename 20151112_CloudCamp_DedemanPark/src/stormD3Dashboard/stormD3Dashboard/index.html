<!DOCTYPE html>
    <html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>Dashboard</title>
        <style>
            body {
  font: 10px sans-serif;
}

.axis path,
.axis line {
  fill: none;
  stroke: #001;
  shape-rendering: crispEdges;
}

.x.axis path {
  display: none;
}

.line {
  fill: none;
  stroke: steelblue;
  stroke-width: 1.5px;
}
        </style>
        <!--Script references. -->
        <!--Reference the jQuery library. -->
        <script src="Scripts/jquery-1.10.2.min.js"></script>
        <!--Reference the SignalR library. -->
        <script src="Scripts/jquery.signalR-2.0.2.min.js"></script>
        <!--Reference the autogenerated SignalR hub script. -->
        <script src="signalr/hubs"></script>
        <!--Reference d3.js.-->
        <script src="http://d3js.org/d3.v3.min.js"></script>
    </head>
    <body>
        <script>
            var parseDate = d3.time.format("%Y-%m-%dT%H:%M:%S.%LZ").parse;;
            var color = d3.scale.category10();
            var margin = { top: 6, right: 0, bottom: 20, left: 40 },
                width = 960 - margin.right,
                height = 240 - margin.top - margin.bottom;
            var xrange = d3.time.scale()
                .range([0, width]);
            var yrange = d3.scale.linear()
                .range([height, 0]);

            var xAxis = d3.svg.axis()
                .scale(xrange)
                .orient("bottom");

            var yAxis = d3.svg.axis()
                .scale(yrange)
                .orient("left");

            var line = d3.svg.line()
                .interpolate("basis")
                .x(function (d) {
                    return xrange(parseDate(d.key));
                })
                .y(function (d) {
                    return yrange(d.value);
                });

            var svg = d3.select("body").append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            $(function() {
                data = {
                    "0": {
                        "2015-02-02T10:02:00.000Z": 0,
                        "2015-02-02T10:03:00.000Z": 0,
                        "2015-02-02T10:04:00.000Z": 0,
                        "2015-02-02T10:05:00.000Z": 0,
                        "2015-02-02T10:06:00.000Z": 0,
                        "2015-02-02T10:07:00.000Z": 0,
                        "2015-02-02T10:08:00.000Z": 0,
                        "2015-02-02T10:09:00.000Z": 0,
                        "2015-02-02T10:10:00.000Z": 0,
                        "2015-02-02T10:11:00.000Z": 0
                    },
                    "1": {
                        "2015-02-02T10:02:00.000Z": 0,
                        "2015-02-02T10:03:00.000Z": 0,
                        "2015-02-02T10:04:00.000Z": 0,
                        "2015-02-02T10:05:00.000Z": 0,
                        "2015-02-02T10:06:00.000Z": 0,
                        "2015-02-02T10:07:00.000Z": 0,
                        "2015-02-02T10:08:00.000Z": 0,
                        "2015-02-02T10:09:00.000Z": 0,
                        "2015-02-02T10:10:00.000Z": 0,
                        "2015-02-02T10:11:00.000Z": 0
                    },
                    "2": {
                        "2015-02-02T10:02:00.000Z": 0,
                        "2015-02-02T10:03:00.000Z": 0,
                        "2015-02-02T10:04:00.000Z": 0,
                        "2015-02-02T10:05:00.000Z": 0,
                        "2015-02-02T10:06:00.000Z": 0,
                        "2015-02-02T10:07:00.000Z": 0,
                        "2015-02-02T10:08:00.000Z": 0,
                        "2015-02-02T10:09:00.000Z": 0,
                        "2015-02-02T10:10:00.000Z": 0,
                        "2015-02-02T10:11:00.000Z": 0
                    },
                    "3": {
                        "2015-02-02T10:02:00.000Z": 0,
                        "2015-02-02T10:03:00.000Z": 0,
                        "2015-02-02T10:04:00.000Z": 0,
                        "2015-02-02T10:05:00.000Z": 0,
                        "2015-02-02T10:06:00.000Z": 0,
                        "2015-02-02T10:07:00.000Z": 0,
                        "2015-02-02T10:08:00.000Z": 0,
                        "2015-02-02T10:09:00.000Z": 0,
                        "2015-02-02T10:10:00.000Z": 0,
                        "2015-02-02T10:11:00.000Z": 0
                    },
                    "4": {
                        "2015-02-02T10:02:00.000Z": 0.0,
                        "2015-02-02T10:03:00.000Z": 0.0,
                        "2015-02-02T10:04:00.000Z": 0.0,
                        "2015-02-02T10:05:00.000Z": 0.0,
                        "2015-02-02T10:06:00.000Z": 0.0,
                        "2015-02-02T10:07:00.000Z": 0.0,
                        "2015-02-02T10:08:00.000Z": 0.0,
                        "2015-02-02T10:09:00.000Z": 0.0,
                        "2015-02-02T10:10:00.000Z": 0.0,
                        "2015-02-02T10:11:00.000Z": 0.0
                    }
                }


                var entries = d3.entries(data);

                color.domain(entries.map(function(d) {
                    return d;
                }));

                var allX = d3.values(data).map(d3.keys)
                    .reduce(function(a, b) { return a.concat(b); }).map(parseDate);
                var allY = d3.values(data).map(d3.values)
                    .reduce(function(a, b) { return a.concat(b); });

                xrange.domain([
                    d3.min(allX, function(d) {
                        return d;
                    }), d3.max(allX, function(d) {
                        return d;
                    })
                ]);

                yrange.domain([
                    d3.min(allY, function(d) {
                        return d;
                    }), d3.max(allY, function(d) {
                        return d;
                    })
                ]);

                svg.append("g")
                    .attr("class", "y axis")
                    .call(yAxis);

                svg.append("g")
                    .attr("class", "x axis")
                    .attr("transform", "translate(0," + height + ")")
                    .call(xAxis);

                var element = svg.selectAll(".element")
                    .data(entries)
                    .enter().append("g")
                    .attr("class", "element");

                element.append("path")
                    .attr("class", "line")
                    .attr("d", function(d) {

                        var entry = d3.entries(d.value);

                        return line(entry);
                    })
                    .style("stroke", function(d) {
                        return color(d.key);
                    });


                //wire up the SignalR client and listen for messages
                var chat = $.connection.dashHub;

                chat.client.acceptData = function(dataIn) {
                    var incomingData = JSON.parse(dataIn);
                    data = incomingData["Humidity"];

                };
                //start listening
                //$.connection.hub.logging = true;
                $.connection.hub.start().done(function() {
                    chat.server.startListening();
                });

                //tick for D3 graphics
                var inter = setInterval(function() {
                    tick();
                }, 15000);

                function tick() {


                    allX = d3.values(data).map(d3.keys)
                        .reduce(function(a, b) { return a.concat(b); }).map(parseDate);
                    allY = d3.values(data).map(d3.values)
                        .reduce(function(a, b) { return a.concat(b); });

                    xrange.domain([
                        d3.min(allX, function(d) {
                            return d;
                        }), d3.max(allX, function(d) {
                            return d;
                        })
                    ]);

                    yrange.domain([
                        d3.min(allY, function(d) {
                            return d;
                        }), d3.max(allY, function(d) {
                            return d;
                        })
                    ]);

                    entries = d3.entries(data);

                    d3.select("svg").remove();
                    svg = d3.select("body").append("svg")
                        .attr("width", width + margin.left + margin.right)
                        .attr("height", height + margin.top + margin.bottom)
                        .append("g")
                        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                    svg.append("g")
                        .attr("class", "y axis")
                        .call(yAxis);

                    svg.append("g")
                        .attr("class", "x axis")
                        .attr("transform", "translate(0," + height + ")")
                        .call(xAxis);

                    element = svg.selectAll(".element")
                        .data(entries)
                        .enter().append("g")
                        .attr("class", "element");

                    element.append("path")
                        .attr("class", "line")
                        .attr("d", function(d) {

                            var entry = d3.entries(d.value);

                            return line(entry);
                        })
                        .style("stroke", function(d) {
                            return color(d.key);
                        });
                };
            });
        </script>
        <h1>Humidity</h1>
        <p>Note: This graphic will take a few moments to load</p>
    </body>
    </html>
